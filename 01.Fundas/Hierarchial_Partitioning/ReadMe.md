### Hierarchial Partitioning

We need to get the numbers when we are choosing `tenantId` + `siteId` + `deviceId` as hierarchial partition key.
There is also a recommended partition key mentioned [here](https://youtu.be/oToAY8NGWA0?t=1425) : `deviceId` + `date` for device telemetry which will enable us :

For us, deviceId will be `manufacterer name` and `serial number`.

- Each device can exceed 20GB of data
- No need to implement synthetic keys

Let's consider some numbers to calculate benchmark: 

- 1 device generates nearly ~=2 Lac records per month
- We need to consider `1 year` TTL for such records

Let's create collections for `15 tenants` each having `100 sites`.
Each site would have `5 devices` generating a `~5KB` document every `30th sec`.
Devices will only only be active for 12hrs (considering only US hours).

#### What will be the number of telemetry requests generated every day by 100 sites?

```
100 sites * 120 requests per hour * 12 hours
=  100 * 1440 (1 device generating telemetry for 12 hours -US consideration - generating telemetry every 30 secs)
Number of telemetry requests generated by 1 device each , for 100 sites in a day =   144000

For 5 devices = 144000*5 => 720,000
```

#### What should be the storage requirements for storing 720,000 records?
Considering each document stored in cosmos collection has `~5KB` size.

```
Total size required for 1 day = (720,000 * 5)/1024*1024 => 3.43GB ~=3.5GB per day

For 1 day , size requirement = 3.5 GB
For 2 days, size requirement = 7 GB
For 3 days, size requirement = 10.5GB
For 4 days, size requirement = 14GB
For 5 days, size requirement = 17.5GB
For 6 days, size requirement = 21GB
For 7 days, size requirement = 24.5GB
For month , size requirement = 105 GB per month 
```

#### In action

> 1. Take sample collection for 5 devices from dev cosmos

`SELECT DISTINCT c.metadata["customerDeviceClass"] FROM c`

Returns 3 deviceClasses : `Bakery Oven` , `Fryer` , `Rotisserie`  . Let's assume 2 more `TypeA` , `TypeB`

> 2. Use the [DVDwriterBenchmark tool](https://github.com/napsterhopes/AZ/tree/main/CosmosDB/Benchmark_Calculation) for calculating RU/s for write operations. Modify code for parallelizing task where each device writes data every 30 secs.


--- 

> References : 

- https://www.youtube.com/watch?v=oToAY8NGWA0
- https://github.com/AzureCosmosDB/HierarchicalPartitionKeysFeedbackGroup
- https://learn.microsoft.com/en-us/azure/cosmos-db/hierarchical-partition-keys?tabs=net-v3%2Cbicep
